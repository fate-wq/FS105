<%- include ("meta.ejs") %>
<body>

    <%- include ("navbar.ejs") %>
    <%- include ("navUser.ejs") %>

    <div class="ctn-login">

        <p class="f-sanserif-regular mt-5">
            Click on the update to edit your profile.
        </p>

        <h1 class="f-sanserif-bold mt-5">USER PROFILE</h1>

        <div class="ctn-job3">
            <div class="row">
                <div class="ctn-job2-col1">
                    <img src="/images/avatar.png" class="img-avatar">

                    <ul class="job-Body ul-joblist mt-5">
                            <li class="mt-3">Full Name: <br> <span class="f-sanserif-bold">Full Name</span></li>
                            <li class="mt-3">Date Of Birth:<br> <span class="f-sanserif-bold">Date Of Birth</span></li>
                            <li class="mt-3">About Me:<br> <span class="f-sanserif-bold">About Me</span></li>
                    </ul>

                    <h1 class="f-sanserif-bold mt-5">CONTACT DETAILS</h1>
                    <ul class="job-Body ul-joblist mt-5">
                        <li class="mt-3">Email:<br> <span class="f-sanserif-bold">Email</span></li>
                    </ul>


                    <h1 class="f-sanserif-bold mt-5">PAYNOW ACCOUNT</h1>
                    <ul class="job-Body ul-joblist mt-5">
                        <li class="mt-3">Mobile No.:<br> <span class="f-sanserif-bold">Mobile No.</span></li>
                    </ul>

                    <h1 class="f-sanserif-bold mt-5">Work Experience 1</h1>
                    <ul class="job-Body ul-joblist mt-5">
                        <li class="mt-3">Job Title:<br> <span class="f-sanserif-bold">Job Title</span></li>
                        <li class="mt-3">Company Name:<br> <span class="f-sanserif-bold">Company Name</span></li>
                        <li class="mt-3">Duration:<br> <span class="f-sanserif-bold">Duration</span></li>
                    </ul>

                    <h1 class="f-sanserif-bold mt-5">Skills</h1>
                    <ul class="job-Body ul-joblist mt-5">
                        <li class="mt-3">Type of Skills:<br> <span class="f-sanserif-bold">Skills</span></li>
                        <li class="mt-3">Type of Skills:<br> <span class="f-sanserif-bold">Skills</span></li>
                    </ul>

                    <button type="submit" class="button-createProfile">Update Profile</button>

                </div>
            </div>
        </div>  
    </div>

    <%- include ("footer.ejs") %>

    <script>
        const steps = document.querySelectorAll('.step-wizard-item');
        const formSteps = document.querySelectorAll('.form-step');
        const nextBtns = document.querySelectorAll('.next-section');
        const prevBtns = document.querySelectorAll('.prev-section');
        const cancelBtns = document.querySelectorAll('.cancel-section');
        const workExperienceContainer = document.getElementById('work-experience-container');
        const addWorkExperienceBtn = document.getElementById('add-work-experience');
        const skillsContainer = document.getElementById('skills-container');
        const addSkillBtn = document.getElementById('add-skill');

        let currentStep = 1;
        let workExperienceCount = 1; // Track the number of work experience sections

        function updateStep(step) {
            formSteps.forEach((formStep, index) => {
                formStep.style.display = index === (step - 1) ? 'block' : 'none';
            });
            steps.forEach((stepItem, index) => {
                stepItem.classList.toggle('current-item', index === (step - 1));
            });
        }

// Update next button click event listeners to validate required fields
nextBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        // Check if all required fields in the current step are filled
        const currentFormStep = document.querySelector(`.form-step[data-step="${currentStep}"]`);
        const inputs = currentFormStep.querySelectorAll('input[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                isValid = false;
                input.classList.add('error'); 
            } else {
                input.classList.remove('error');
            }
        });

        if (isValid) {
            currentStep++;
            updateStep(currentStep);
        } else {
            // Optionally, you can display an error message or highlight the required fields
            console.log('Please fill in all required fields.');
            alert('Please fill in all required fields.');
        }
    });
});


        prevBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentStep--;
                updateStep(currentStep);
            });
        });

// Cancel Button Click Event
cancelBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        if (currentStep === 2) { // Work Experience
            workExperienceContainer.lastElementChild.remove();
            workExperienceCount--;
            // Hide Remove Work Experience Button if no sections left
            if (workExperienceCount <= 1) {
                document.querySelector('.form-step[data-step="2"] .cancel-section').style.display = 'none';
            }
        } else if (currentStep === 3) { // Skills
            skillsContainer.lastElementChild.remove();
            // Hide Remove Skill Button if no sections left
            if (skillsContainer.childElementCount === 1) {
                document.querySelector('.form-step[data-step="3"] .cancel-section').style.display = 'none';
            }
        }
        updateStep(currentStep);
    });
});

// Add Work Experience Button Click Event
addWorkExperienceBtn.addEventListener('click', () => {
    workExperienceCount++;
    const newWorkExperience = document.createElement('div');
    newWorkExperience.innerHTML = `
        <h1 class="f-sanserif-bold mt-5">Work Experience ${workExperienceCount}</h1>
        <div class="input-group">
            <input type="text" name="jobTitle[]" placeholder="Job Title">
            <label for="jobTitle">Job Title</label>
        </div>
        <div class="input-group">
            <input type="text" name="companyName[]" placeholder="Company Name">
            <label for="companyName">Company Name</label>
        </div>
        <div class="input-group">
            <input type="text" name="jobDuration[]" placeholder="Duration">
            <label for="jobDuration">Duration</label>
        </div>
    `;
    workExperienceContainer.appendChild(newWorkExperience);

    // Show Remove Work Experience Button
    if (workExperienceCount > 1) {
        document.querySelector('.form-step[data-step="2"] .cancel-section').style.display = 'block';
    }
});

// Add Skill Button Click Event
addSkillBtn.addEventListener('click', () => {
    const newSkill = document.createElement('div');
    newSkill.classList.add('input-group');
    newSkill.innerHTML = `
        <input type="text" name="skills[]" placeholder="Skill">
        <label for="skill">Skill</label>
    `;
    skillsContainer.appendChild(newSkill);

    // Show Remove Skill Button
    document.querySelector('.form-step[data-step="3"] .cancel-section').style.display = 'block';
});

    // Include the userId in the userData object
    const userId = "<%= userId %>"; 
    async function populateData() {
    try {
        const response = await fetch('/api/populateData', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ userId: userId }) // Send only userId
        });
        const result = await response.json();
        console.log("Result", result);

        // Directly access properties from the result object
        if (result.users) {
            console.log("Username:", result.users.username);
            console.log("Email:", result.users.email);
            document.getElementById('fullName').value = result.users.username || '';
            document.getElementById('email2').value = result.users.email || '';
        } else {
            console.log('User data not available.');
        }

        if (result.message) {
            alert(result.message);
        } else if (result.error) {
            alert(result.error);
        }
    } catch (e) {
        console.error("Error fetching profile data: ", e);
        alert("Error fetching profile data");
    }
}

populateData();


    // Define an object to store user data
    const userData = {
        userId: userId,
        fullName: '',
        dmBirth: '',
        email: '',
        paynowMobile: '',
        about: '', // Add about field
        workExperience: [],
        skills: [],
        resume: ''
    };

    // Function to update userData object with form values
    function updateUserData() {
        userData.fullName = document.getElementById('fullName').value;
        userData.dmBirth = document.getElementById('dmBirth').value;
        userData.email = document.getElementById('email2').value;
        userData.paynowMobile = document.getElementById('paynowMobile').value;
        userData.about = document.getElementById('about').value; // Add about field

        // Collect work experience data
        const jobTitles = document.getElementsByName('jobTitle[]');
        const companyNames = document.getElementsByName('companyName[]');
        const jobDurations = document.getElementsByName('jobDuration[]');
        userData.workExperience = [];
        for (let i = 0; i < jobTitles.length; i++) {
            userData.workExperience.push({
                jobTitle: jobTitles[i].value,
                companyName: companyNames[i].value,
                jobDuration: jobDurations[i].value
            });
        }

        // Collect skills data
        const skills = document.getElementsByName('skills[]');
        userData.skills = [];
        skills.forEach(skill => {
            userData.skills.push(skill.value);
        });

        // Get resume file if uploaded
        const resume = document.getElementById('resume').files[0];
        userData.resume = resume ? resume.name : 'Not uploaded';
    }

    // Submit form event listener
    const form = document.querySelector('form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault(); // Prevent default form submission

        updateUserData();
        console.log(userData);    
        try {
            const response = await fetch('/api/updateProfile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });
            const result = await response.json();
            console.log(result);
            if (result.message) {
                alert(result.message);
            } else if (result.error) {
                alert(result.error);
            }
        } catch (e) {
            console.error("Error updating profile: ", e);
            alert("Error updating profile");
        }
    });
    

        updateStep(currentStep);
    </script>

</body>
</html>