<%- include ("meta.ejs") %>
<body>

    <%- include ("navbar.ejs") %>
    <%- include ("navUser.ejs") %>

    <div class="ctn-login">

        <% const products = [
            { id: 1, title: "Yellow Safety Helmet", price: 2300, image: "/images/safety.png", description: "Protective hard hat with comfortable 4-point ratchet suspension and standard brow pad. Available in several colors. Meets requirements of ANSI/ISEA Z89.1-2014 Type 1, Class G and E." },
            // Add more products here
        ]; %>

        <% products.forEach(product => { %>
        <div class="ctn-job2">
            <div class="row">
                <div class="ctn-job2-col1">
                    <h3 class="job-Title"><%= product.title %></h3>
                    <p class="mt-3">Product by: <span class="f-sanserif-bold">WerkPay</span></p>
                    <button class="button-jobtag">Best Priced</button>
                    <button class="button-jobtag">10% Discount</button>

                    <img src="<%= product.image %>" alt="" class="img-prdt mt-5">

                    <button class="button-expand mt-5">Expand Product Descriptions</button>

                    <div class="content job-Body2 mt-4">
                        <h3 class="job-SubHeader mt-5">Product Descriptions</h3>
                        <p class="job-Body mt-4"><%= product.description %></p>
                    </div>
                </div>

                <div class="ctn-job2-col2">
                    <h3 class="f-sanserif-bold">$<%= (product.price / 100).toFixed(2) %></h3>
                    <div class="input-group">
                        <input type="number" id="quantity-<%= product.id %>" name="quantity" min="1" placeholder="Enter Quantity" required>
                    </div>

                    <button class="button-apply" onclick="redirectToPaymentPage(<%= product.id %>)">Buy</button>

                </div>
            </div>
        </div>
        <% }); %>
        
    </div>

    <%- include ("footer.ejs") %>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var expandButtons = document.getElementsByClassName("button-expand");
            console.log("Expand buttons found: ", expandButtons.length);

            for (var i = 0; i < expandButtons.length; i++) {
                expandButtons[i].addEventListener("click", function() {
                    console.log("Button clicked");
                    var content = this.nextElementSibling;
                    if (content && content.style) {
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    } else {
                        console.log("No content found");
                    }
                });
            }
        });

        async function redirectToPaymentPage(productId) {
            const quantity = document.querySelector(`#quantity-${productId}`).value;
            if (!quantity) {
                alert('Please enter a quantity.');
                return;
            }

            const response = await fetch('/create-checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quantity: quantity, productId: productId }),
            });

            const session = await response.json();

            const stripe = Stripe('pk_test_51PTh7q2MEKdQenEdi0K8ndP3lK5ZqEeYIO2frfdabb4fuGpMZ3adVarVuVdBoBOC5ENnyS9EeqMcZKbbFGBAbHjr00MFbnapzj'); // Replace with your actual public key
            const { error } = await stripe.redirectToCheckout({ sessionId: session.id });

            if (error) {
                document.getElementById('payment-message').textContent = error.message;
                document.getElementById('payment-message').classList.remove('hidden');
            }
        }
    </script>

</body>
</html>